name: ğŸš€ Deploy Expense Tracker to DigitalOcean

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual deployment

jobs:
  deploy:
    name: SSH Deploy via Docker Compose
    runs-on: ubuntu-latest
    
    steps:
      # 1ï¸âƒ£ Checkout the code
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Set up SSH
      - name: ğŸ” Set up SSH access
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # 3ï¸âƒ£ Sync project files to server
      - name: ğŸ“¦ Sync project files to server
        run: |
          rsync -az --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='*.log' \
            --exclude='.env' \
            --exclude='.env.local' \
            --exclude='.env.production' \
            --exclude='.next' \
            --exclude='coverage' \
            --exclude='dist' \
            --exclude='build' \
            --exclude='uploads' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.USERNAME }}@${{ secrets.HOST }}:${{ secrets.PROJECT_DIR }}

      # 4ï¸âƒ£ Inject environment file
      - name: âš™ï¸ Inject environment variables into server
        run: |
          echo "${{ secrets.ENV_FILE }}" | base64 -d > temp_env_file
          scp -o StrictHostKeyChecking=no temp_env_file \
            ${{ secrets.USERNAME }}@${{ secrets.HOST }}:${{ secrets.PROJECT_DIR }}/.env
          rm temp_env_file
          
          ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
          set -e
          cd "${{ secrets.PROJECT_DIR }}"
          
          echo "âœ… Environment file successfully written."
          echo "ğŸ“‹ Verifying environment file..."
          if [ -f .env ]; then
            echo "âœ… .env file exists"
            echo "ğŸ“Š Environment file size: $(wc -l < .env) lines"
          else
            echo "âŒ .env file not found!"
            exit 1
          fi
          EOF

      # 5ï¸âƒ£ Ensure required directories exist
      - name: ğŸ“ Ensure required directories exist on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
          set -e
          cd "${{ secrets.PROJECT_DIR }}"
          
          echo "ğŸ“ Creating required directories..."
          mkdir -p uploads
          mkdir -p postgres_data
          mkdir -p .next
          
          echo "ğŸ” Setting proper permissions..."
          chmod 755 uploads
          chmod 755 postgres_data
          
          echo "âœ… Directory structure ready."
          ls -la
          EOF

      # 6ï¸âƒ£ Build & restart Docker containers
      - name: ğŸ³ Build & restart Docker containers
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
          set -euo pipefail
          cd "${{ secrets.PROJECT_DIR }}"
          
          echo "ğŸ§± Pulling latest Docker base images..."
          docker compose pull || true
          
          echo "ğŸ›‘ Stopping existing containers gracefully..."
          docker compose down --remove-orphans || true
          
          echo "ğŸ§¹ Cleaning up old containers and networks..."
          docker container prune -f || true
          docker network prune -f || true
          
          echo "ğŸ› ï¸ Building application image..."
          docker compose build --no-cache app
          
          echo "ğŸš€ Starting services..."
          docker compose up -d --remove-orphans
          
          echo "â³ Waiting for services to be ready..."
          sleep 30
          
          echo "ğŸ¥ Checking service health..."
          docker compose ps
          
          echo "ğŸ“Š Checking application health..."
          # Wait for app to be ready and test health endpoint
          for i in {1..10}; do
            if curl -f http://localhost:3000/api/health >/dev/null 2>&1; then
              echo "âœ… Application is healthy!"
              break
            else
              echo "â³ Waiting for application... (attempt $i/10)"
              sleep 10
            fi
          done
          
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f || true
          
          echo "âœ… Deployment complete!"
          echo "ğŸ“‹ Running containers:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo "ğŸ“Š Application logs (last 20 lines):"
          docker compose logs --tail=20 app
          EOF

      # 7ï¸âƒ£ Run database migrations
      - name: ğŸ—„ï¸ Run database migrations
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
          set -e
          cd "${{ secrets.PROJECT_DIR }}"
          
          echo "ğŸ—„ï¸ Running database migrations..."
          docker compose exec -T app npx prisma db push --accept-data-loss || {
            echo "âš ï¸ Database migration failed, but continuing..."
          }
          
          echo "ğŸ”„ Generating Prisma client..."
          docker compose exec -T app npx prisma generate || {
            echo "âš ï¸ Prisma generate failed, but continuing..."
          }
          
          echo "âœ… Database operations completed."
          EOF

      # 8ï¸âƒ£ Verify deployment
      - name: âœ… Verify deployment
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
          set -e
          cd "${{ secrets.PROJECT_DIR }}"
          
          echo "ğŸ” Final deployment verification..."
          
          # Check if containers are running
          if ! docker compose ps | grep -q "Up"; then
            echo "âŒ No containers are running!"
            docker compose logs
            exit 1
          fi
          
          # Check application health
          if curl -f http://localhost:3000/api/health >/dev/null 2>&1; then
            echo "âœ… Application health check passed!"
          else
            echo "âš ï¸ Application health check failed, but deployment completed."
            echo "ğŸ“Š Application logs:"
            docker compose logs --tail=50 app
          fi
          
          # Show final status
          echo "ğŸ“‹ Final container status:"
          docker compose ps
          
          echo "ğŸ’¾ Disk usage:"
          df -h
          
          echo "ğŸ‰ Deployment verification completed!"
          EOF

      # 9ï¸âƒ£ Send deployment notification (optional)
      - name: ğŸ“¢ Send deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
            echo "ğŸŒ Application should be available at your server IP:3000"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸ“Š Check the logs above for details."
          fi